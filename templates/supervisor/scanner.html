{% extends 'supervisor/base.html' %}
{% load static %}

{% block title %}QR Scanner - Supervisor - Greatness Community Relief{% endblock %}

{% block content %}
{% csrf_token %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">QR Code Scanner</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-info" id="switchCamera">
                <i class="bi bi-camera-reels me-1"></i>Switch Camera
            </button>
            <button type="button" class="btn btn-sm btn-secondary" id="flashlight">
                <i class="bi bi-lightbulb me-1"></i>Flashlight
            </button>
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="showScanHistory()">
            <i class="bi bi-clock-history me-1"></i>Scan History
        </button>
    </div>
</div>

<!-- Scanner Status -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="alert alert-info d-flex align-items-center">
            <i class="bi bi-info-circle me-3 fs-4"></i>
            <div>
                <h6 class="alert-heading mb-1">Scanner Ready</h6>
                <p class="mb-0">Position the QR code within the scanner viewfinder or enter the code manually below.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="text-center">
            <div class="h4 text-success mb-1" id="todayScansCount">---</div>
            <small class="text-muted">QR Codes Scanned Today</small>
        </div>
    </div>
</div>

<!-- Main Scanner Interface -->
<div class="row">
    <div class="col-lg-8">
        <div class="scanner-container">
            <h5 class="mb-4 text-center">Manual QR Code Lookup</h5>
            
            <!-- Manual Entry Form -->
            <div class="card" id="manualEntryForm">
                <div class="card-body">
                    <h6 class="card-title">Enter QR Code or Reference Number</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control form-control-lg" id="manualQRCode" 
                               placeholder="Enter QR code or reference number (e.g., REF-240830001)">
                        <button class="btn btn-primary btn-lg" onclick="processManualEntry()">
                            <i class="bi bi-search me-2"></i> Lookup
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        You can enter either a QR code or the application reference number.
                    </small>
                </div>
            </div>
            
            <!-- Lookup Result -->
            <div id="scanResult"></div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Today's Pickup Queue -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Today's Pickup Queue</h6>
            </div>
            <div class="card-body" id="todayPickupQueue">
                <!-- Loading state -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Loading pickup queue...</p>
                </div>
            </div>
                
                <div class="text-center mt-3">
                    <a href="{% url 'supervisor_schedule' %}" class="btn btn-sm btn-outline-primary">
                        View Full Schedule
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Scanner Statistics -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Scanner Statistics</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="h4 text-success mb-1" id="scans-today">---</div>
                        <small class="text-muted">Today</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="h4 text-info mb-1" id="scans-week">---</div>
                        <small class="text-muted">This Week</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-primary mb-1" id="scans-month">---</div>
                        <small class="text-muted">This Month</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-warning mb-1" id="scans-invalid">---</div>
                        <small class="text-muted">Invalid</small>
                    </div>
                </div>
                
                <hr>
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Success Rate</small>
                    <small class="fw-bold text-success" id="success-rate">---</small>
                </div>
                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 0%" id="success-progress"></div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Avg. Processing Time</small>
                    <small class="fw-bold" id="avg-processing-time">---</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Scans -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Recent Scans</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshRecentScans()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Time</th>
                                <th>Reference</th>
                                <th>Applicant</th>
                                <th>Package</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="recentScansTable">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2 text-muted">Loading recent lookups...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scan Details Modal -->
<div class="modal fade" id="scanDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scanDetailsContent">
                    <!-- Details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printReceipt()">
                    <i class="bi bi-printer me-1"></i>Print Receipt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scan History Modal -->
<div class="modal fade" id="scanHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="historyDateFrom" placeholder="From Date">
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="historyDateTo" placeholder="To Date">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="filterScanHistory()">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Reference</th>
                                <th>Applicant</th>
                                <th>Package</th>
                                <th>Supervisor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="scanHistoryTable">
                            <!-- History data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportScanHistory()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.scanner-viewfinder {
    width: 100%;
    max-width: 500px;
    height: 400px;
    margin: 0 auto;
    border: 3px solid #195296;
    border-radius: 15px;
    position: relative;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.scanner-viewfinder video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
}

.scanner-corners {
    position: absolute;
    top: 20px;
    left: 20px;
    right: 20px;
    bottom: 20px;
    pointer-events: none;
    z-index: 10;
}

.scanner-corners::before,
.scanner-corners::after {
    content: '';
    position: absolute;
    width: 30px;
    height: 30px;
    border: 3px solid #28a745;
}

.scanner-corners::before {
    top: 0;
    left: 0;
    border-right: none;
    border-bottom: none;
}

.scanner-corners::after {
    top: 0;
    right: 0;
    border-left: none;
    border-bottom: none;
}

.scanner-corners {
    background-image: 
        linear-gradient(to right, #28a745 3px, transparent 3px),
        linear-gradient(to bottom, #28a745 3px, transparent 3px),
        linear-gradient(to left, #28a745 3px, transparent 3px),
        linear-gradient(to top, #28a745 3px, transparent 3px);
    background-size: 30px 30px;
    background-position: top left, top left, bottom right, bottom right;
    background-repeat: no-repeat;
}

.scanner-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    z-index: 20;
}

.scan-line {
    position: absolute;
    top: 50%;
    left: 20px;
    right: 20px;
    height: 2px;
    background: linear-gradient(90deg, transparent, #28a745, transparent);
    animation: scan-animation 2s linear infinite;
    z-index: 15;
}

@keyframes scan-animation {
    0% { top: 20px; }
    100% { top: calc(100% - 20px); }
}

.scanning .scan-line {
    display: block;
}

.scan-line {
    display: none;
}

.camera-permission-error {
    color: #dc3545;
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- ZXing-JS Library for QR Code Scanning -->
<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>

<script>
class ReliefQRScanner {
    constructor() {
        this.codeReader = null;
        this.selectedDeviceId = null;
        this.isScanning = false;
        this.videoElement = null;
        this.scanHistory = [];
        
        this.init();
    }
    
    async init() {
        // Initialize ZXing code reader
        this.codeReader = new ZXing.BrowserQRCodeReader();
        
        // Set up event listeners
        this.setupEventListeners();
        
        // Load scanner statistics from backend
        await this.loadScannerStatistics();
        
        // Load pickup queue from backend
        await this.loadPickupQueue();
        
        // Load recent scans
        await this.loadRecentScans();
        
        console.log('ReliefQRScanner initialized successfully');
    }
    
    setupEventListeners() {
        const startScanBtn = document.getElementById('startScan');
        const manualEntryBtn = document.getElementById('manualEntry');
        const switchCameraBtn = document.getElementById('switchCamera');
        
        if (startScanBtn) {
            startScanBtn.addEventListener('click', () => this.toggleScanning());
        }
        
        if (manualEntryBtn) {
            manualEntryBtn.addEventListener('click', () => this.toggleManualEntry());
        }
        
        if (switchCameraBtn) {
            switchCameraBtn.addEventListener('click', () => this.switchCamera());
        }
        
        // Manual entry form
        const manualInput = document.getElementById('manualQRCode');
        if (manualInput) {
            manualInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.processManualEntry();
                }
            });
        }
    }
    
    async toggleScanning() {
        if (this.isScanning) {
            this.stopScanning();
        } else {
            await this.startScanning();
        }
    }
    
    async startScanning() {
        if (this.isScanning) return;
        
        try {
            // Get camera permission and available devices
            const videoInputDevices = await this.codeReader.listVideoInputDevices();
            
            if (videoInputDevices.length === 0) {
                this.showError('No camera devices found. Please connect a camera and try again.');
                return;
            }
            
            // Use the first available camera (usually back camera on mobile)
            this.selectedDeviceId = videoInputDevices[0].deviceId;
            
            // Create video element if not exists
            this.createVideoElement();
            
            // Update UI
            this.updateScanButton('Scanning...', true, 'btn-danger');
            this.addScanningAnimation();
            
            // Start decoding
            this.isScanning = true;
            
            await this.codeReader.decodeFromVideoDevice(
                this.selectedDeviceId,
                this.videoElement,
                (result, error) => {
                    if (result) {
                        // Successfully scanned QR code
                        console.log('QR Code scanned:', result.getText());
                        this.processScannedCode(result.getText());
                    }
                    
                    if (error && error instanceof ZXing.NotFoundException) {
                        // This is normal - just means no QR code found in current frame
                        // Continue scanning silently
                    } else if (error) {
                        console.warn('QR scan error:', error);
                    }
                }
            );
            
        } catch (error) {
            console.error('Camera access error:', error);
            this.handleCameraError(error);
        }
    }
    
    stopScanning() {
        if (!this.isScanning) return;
        
        this.isScanning = false;
        
        // Stop the code reader
        if (this.codeReader) {
            this.codeReader.reset();
        }
        
        // Remove video element
        this.removeVideoElement();
        
        // Update UI
        this.updateScanButton('Start Scanning', false, 'btn-success');
        this.removeScanningAnimation();
        
        console.log('QR scanning stopped');
    }
    
    createVideoElement() {
        const viewfinder = document.querySelector('.scanner-viewfinder');
        if (!viewfinder) return;
        
        // Clear existing content
        viewfinder.innerHTML = '<div class="scanner-corners"></div><div class="scan-line"></div>';
        
        // Create video element
        this.videoElement = document.createElement('video');
        this.videoElement.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
        this.videoElement.setAttribute('playsinline', true);
        
        viewfinder.appendChild(this.videoElement);
    }
    
    removeVideoElement() {
        const viewfinder = document.querySelector('.scanner-viewfinder');
        if (viewfinder) {
            viewfinder.innerHTML = '<div class="scanner-corners"></div><i class="bi bi-qr-code-scan display-4 text-muted"></i>';
        }
        this.videoElement = null;
    }
    
    updateScanButton(text, disabled, className) {
        const startBtn = document.getElementById('startScan');
        if (startBtn) {
            const icon = disabled ? 'stop' : 'play';
            startBtn.innerHTML = `<i class="bi bi-${icon}-fill me-2"></i>${text}`;
            startBtn.disabled = disabled;
            startBtn.className = `btn ${className} btn-lg`;
            console.log('Button updated:', text, className, 'disabled:', disabled);
        }
    }
    
    addScanningAnimation() {
        const viewfinder = document.querySelector('.scanner-viewfinder');
        if (viewfinder) {
            viewfinder.classList.add('scanning');
        }
    }
    
    removeScanningAnimation() {
        const viewfinder = document.querySelector('.scanner-viewfinder');
        if (viewfinder) {
            viewfinder.classList.remove('scanning');
        }
    }
    
    handleCameraError(error) {
        let errorMessage = '';
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage = 'Camera permission denied. Please allow camera access and refresh the page.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            errorMessage = 'No camera devices found. Please connect a camera.';
        } else if (error.name === 'NotSupportedError') {
            errorMessage = 'Camera not supported in this browser.';
        } else {
            errorMessage = `Camera error: ${error.message || 'Unknown error'}`;
        }
        
        this.showError(errorMessage);
        this.updateScanButton('Start Scanning', false, 'btn-success');
    }
    
    async switchCamera() {
        if (!this.isScanning) {
            this.showNotification('Start scanning first to switch cameras', 'info');
            return;
        }
        
        try {
            const videoInputDevices = await this.codeReader.listVideoInputDevices();
            
            if (videoInputDevices.length <= 1) {
                this.showNotification('Only one camera available', 'info');
                return;
            }
            
            // Find current device index
            const currentIndex = videoInputDevices.findIndex(device => device.deviceId === this.selectedDeviceId);
            const nextIndex = (currentIndex + 1) % videoInputDevices.length;
            
            this.selectedDeviceId = videoInputDevices[nextIndex].deviceId;
            
            // Restart scanning with new camera
            this.stopScanning();
            setTimeout(() => this.startScanning(), 500);
            
            this.showNotification('Camera switched successfully', 'success');
            
        } catch (error) {
            console.error('Camera switch error:', error);
            this.showNotification('Failed to switch camera', 'error');
        }
    }
    
    async processScannedCode(qrCodeData) {
        console.log('Raw QR data scanned:', qrCodeData);
        console.log('QR data type:', typeof qrCodeData);
        console.log('QR data length:', qrCodeData.length);
        
        // Stop scanning first
        this.stopScanning();
        
        // Show loading state
        this.showScanResult('loading');
        
        try {
            // Validate and parse QR code data
            let pickupCode = qrCodeData.trim();
            
            // If QR contains JSON, extract pickup_code
            try {
                const qrData = JSON.parse(qrCodeData);
                if (qrData.code) {
                    pickupCode = qrData.code;
                }
            } catch (e) {
                // Not JSON, use as-is
            }
            
            // Validate pickup code format (should be alphanumeric, reasonable length)
            if (!pickupCode || pickupCode.length < 5 || pickupCode.length > 50 || !pickupCode.match(/^[A-Z0-9\-_]+$/i)) {
                this.showScanResult('error', { 
                    message: 'Invalid QR code format. Please scan a valid Relief Program QR code.',
                    code: pickupCode 
                });
                return;
            }
            
            // Call backend API to verify pickup
            console.log('Sending pickup code to API:', pickupCode);
            const response = await fetch('/api/pickups/verify/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                credentials: 'same-origin',
                body: JSON.stringify({ 
                    pickup_code: pickupCode 
                })
            });
            
            const result = await response.json();
            console.log('API response:', result);
            
            if (response.ok && result.success) {
                this.showScanResult('success', result.data);
            } else {
                console.error('API verification failed:', response.status, result);
                this.showScanResult('error', { 
                    message: result.message || `API Error (${response.status}): Unable to verify QR code`,
                    code: pickupCode 
                });
            }
            
        } catch (error) {
            console.error('QR processing error:', error);
            this.showScanResult('error', { 
                message: 'Network error. Please try again.',
                code: qrCodeData 
            });
        }
    }
    
    showScanResult(type, data = null) {
        const resultDiv = document.getElementById('scanResult');
        if (!resultDiv) return;
        
        let resultHtml = '';
        
        if (type === 'loading') {
            resultHtml = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Verifying...</span>
                    </div>
                    <h6>Verifying QR Code...</h6>
                    <p class="text-muted">Please wait while we check the pickup details.</p>
                </div>
            `;
        } else if (type === 'success') {
            resultHtml = `
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-check-circle me-2"></i>Valid QR Code - Ready for Pickup</h6>
                            <span class="badge bg-light text-success">${data.status}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6><i class="bi bi-person me-2"></i>Applicant Information</h6>
                                <table class="table table-sm table-borderless">
                                    <tr><td><strong>Name:</strong></td><td>${data.applicant_name}</td></tr>
                                    <tr><td><strong>Phone:</strong></td><td>${data.phone}</td></tr>
                                    <tr><td><strong>Reference:</strong></td><td>${data.reference_number}</td></tr>
                                    <tr><td><strong>Pickup Code:</strong></td><td><code>${data.pickup_code}</code></td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-box me-2"></i>Package Details</h6>
                                <table class="table table-sm table-borderless">
                                    <tr><td><strong>Package:</strong></td><td>${data.package_name}</td></tr>
                                    <tr><td><strong>Scheduled:</strong></td><td>${data.scheduled_date} ${data.scheduled_time}</td></tr>
                                    <tr><td><strong>Expires:</strong></td><td class="${data.is_expired ? 'text-danger' : 'text-success'}">${data.expiry_date}</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        ${data.package_contents ? `
                            <div class="mb-3">
                                <h6><i class="bi bi-list-check me-2"></i>Package Contents</h6>
                                <div class="p-3 bg-light rounded">
                                    <small>${data.package_contents}</small>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="text-center">
                            <button class="btn btn-success btn-lg me-2" onclick="confirmPickup('${data.pickup_id}', '${data.pickup_code}')">
                                <i class="bi bi-check-circle me-2"></i>Confirm Pickup
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearScanResult()">
                                Scan Another
                            </button>
                        </div>
                    </div>
                </div>
            `;
        } else if (type === 'error') {
            resultHtml = `
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0"><i class="bi bi-x-circle me-2"></i>Invalid QR Code</h6>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-exclamation-triangle display-4 text-warning"></i>
                        </div>
                        <h6>Unable to Verify QR Code</h6>
                        <p class="text-muted">${data.message}</p>
                        ${data.code ? `<p class="small"><strong>Code:</strong> <code>${data.code}</code></p>` : ''}
                        
                        <div class="mt-4">
                            <button class="btn btn-primary me-2" onclick="clearScanResult()">
                                Try Again
                            </button>
                            <button class="btn btn-outline-secondary" onclick="window.qrScanner.toggleManualEntry()">
                                Manual Entry
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        resultDiv.innerHTML = resultHtml;
        
        // Scroll to result on mobile
        if (window.innerWidth < 768) {
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    toggleManualEntry() {
        const form = document.getElementById('manualEntryForm');
        const button = document.getElementById('manualEntry');
        
        if (form.classList.contains('d-none')) {
            form.classList.remove('d-none');
            button.innerHTML = '<i class="bi bi-x me-2"></i>Cancel';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-outline-danger');
            
            document.getElementById('manualQRCode').focus();
        } else {
            form.classList.add('d-none');
            button.innerHTML = '<i class="bi bi-keyboard me-2"></i>Manual Entry';
            button.classList.remove('btn-outline-danger');
            button.classList.add('btn-outline-secondary');
            
            document.getElementById('manualQRCode').value = '';
        }
    }
    
    processManualEntry() {
        const qrCode = document.getElementById('manualQRCode').value.trim();
        if (!qrCode) {
            this.showNotification('Please enter a pickup code', 'warning');
            return;
        }
        
        this.processScannedCode(qrCode);
        this.toggleManualEntry(); // Hide the manual entry form
    }
    
    async loadPickupQueue() {
        try {
            const response = await fetch('/api/pickups/today-queue/', {
                headers: {
                    'X-CSRFToken': this.getCSRFToken()
                },
                credentials: 'same-origin'
            });
            
            if (response.ok) {
                const data = await response.json();
                this.updatePickupQueue(data.pickups || []);
            }
        } catch (error) {
            console.error('Failed to load pickup queue:', error);
        }
    }
    
    updatePickupQueue(pickups) {
        // Update the pickup queue in sidebar
        // For now, keep existing mock data structure
        console.log('Pickup queue loaded:', pickups.length, 'items');
    }
    
    async loadScannerStatistics() {
        try {
            console.log('Loading scanner statistics from pickups API...');
            const response = await fetch('/api/pickups/list/', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                throw new Error(`API returned ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Scanner statistics API response:', data);
            
            // Handle different response structures
            let pickups = [];
            if (Array.isArray(data)) {
                pickups = data;
            } else if (data.results && Array.isArray(data.results)) {
                pickups = data.results;
            } else {
                console.warn('Unexpected API response structure:', data);
                return;
            }
            
            this.updateScannerStatistics(pickups);
            
        } catch (error) {
            console.error('Error loading scanner statistics:', error);
            // Set fallback values
            this.updateScannerStatistics([]);
        }
    }
    
    updateScannerStatistics(pickups) {
        const today = new Date().toISOString().split('T')[0];
        const thisWeekStart = this.getWeekStart(new Date());
        const thisWeekEnd = new Date(thisWeekStart);
        thisWeekEnd.setDate(thisWeekEnd.getDate() + 6);
        const thisMonthStart = new Date();
        thisMonthStart.setDate(1);
        
        // Filter completed pickups (COMPLETED status)
        const completedPickups = pickups.filter(pickup => pickup.status === 'COMPLETED');
        
        // Calculate statistics based on pickup completion times
        const scansToday = completedPickups.filter(pickup => {
            if (!pickup.picked_up_at) return false;
            const pickupDate = new Date(pickup.picked_up_at).toISOString().split('T')[0];
            return pickupDate === today;
        }).length;
        
        const scansThisWeek = completedPickups.filter(pickup => {
            if (!pickup.picked_up_at) return false;
            const pickupDate = new Date(pickup.picked_up_at);
            return pickupDate >= thisWeekStart && pickupDate <= thisWeekEnd;
        }).length;
        
        const scansThisMonth = completedPickups.filter(pickup => {
            if (!pickup.picked_up_at) return false;
            const pickupDate = new Date(pickup.picked_up_at);
            return pickupDate >= thisMonthStart;
        }).length;
        
        // Calculate total valid pickups vs invalid lookups
        const totalValidPickups = pickups.filter(pickup => 
            pickup.status === 'COMPLETED' || pickup.status === 'SCHEDULED' || pickup.status === 'CONFIRMED'
        ).length;
        const invalidScans = pickups.filter(pickup => 
            pickup.status === 'CANCELLED' || pickup.status === 'NO_SHOW'
        ).length;
        
        // Update DOM elements
        this.updateStatElement('#scans-today', scansToday);
        this.updateStatElement('#scans-week', scansThisWeek);
        this.updateStatElement('#scans-month', scansThisMonth);
        this.updateStatElement('#scans-invalid', invalidScans);
        this.updateStatElement('#todayScansCount', scansToday);
        
        // Calculate and update success rate
        const totalScans = totalValidPickups + invalidScans;
        const successRate = totalScans > 0 ? Math.round((totalValidPickups / totalScans) * 100) : 100;
        this.updateStatElement('#success-rate', successRate + '%');
        
        const progressBar = document.getElementById('success-progress');
        if (progressBar) {
            progressBar.style.width = successRate + '%';
        }
        
        // Average processing time (simplified)
        const avgTime = completedPickups.length > 0 ? '1.2s' : 'N/A';
        this.updateStatElement('#avg-processing-time', avgTime);
        
        console.log(`Scanner stats updated: Today=${scansToday}, Week=${scansThisWeek}, Month=${scansThisMonth}, Total=${pickups.length}`);
    }
    
    updateStatElement(selector, value) {
        const element = document.querySelector(selector);
        if (element) {
            element.textContent = value;
        }
    }
    
    getWeekStart(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }
    
    async loadRecentScans() {
        try {
            console.log('Loading recent scans from pickups API...');
            const response = await fetch('/api/pickups/recent/?limit=10', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                throw new Error(`API returned ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Recent scans API response:', data);
            
            if (data.success && Array.isArray(data.scans)) {
                this.updateRecentScans(data.scans);
            } else {
                console.warn('Unexpected recent scans API response:', data);
                this.updateRecentScans([]);
            }
            
        } catch (error) {
            console.error('Error loading recent scans:', error);
            this.updateRecentScans([]);
        }
    }
    
    updateRecentScans(scans) {
        const tbody = document.getElementById('recentScansTable');
        if (!tbody) return;
        
        if (scans.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        No recent lookups found
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = scans.map(scan => {
            // Format the completed time
            let completedTime = 'N/A';
            if (scan.completed_at) {
                const date = new Date(scan.completed_at);
                completedTime = date.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
            }
            
            return `
                <tr>
                    <td>${completedTime}</td>
                    <td>${scan.reference_number}</td>
                    <td>${scan.applicant_name}</td>
                    <td>${this.getPackageName(scan.package_type)}</td>
                    <td>
                        <span class="badge bg-success">Collected</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="viewScanDetails('${scan.reference_number}', '${scan.pickup_code}')">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        console.log(`Recent scans updated with ${scans.length} items`);
    }
    
    formatTime(timeStr) {
        if (timeStr && timeStr.includes(':')) {
            const [hour, minute] = timeStr.split(':');
            const h = parseInt(hour);
            const period = h >= 12 ? 'PM' : 'AM';
            const displayHour = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            return `${displayHour}:${minute} ${period}`;
        }
        return timeStr || 'Not specified';
    }
    
    getPackageName(packageType) {
        const packageNames = {
            'small_basic': 'Small Family',
            'medium_basic': 'Medium Family',
            'large_basic': 'Large Family',
            'emergency': 'Emergency',
            'senior': 'Senior Citizen'
        };
        return packageNames[packageType] || packageType;
    }
    
    showError(message) {
        const viewfinder = document.querySelector('.scanner-viewfinder');
        if (viewfinder) {
            viewfinder.innerHTML = `
                <div class="camera-permission-error text-center">
                    <i class="bi bi-exclamation-triangle display-4 mb-3"></i>
                    <h6>Camera Access Error</h6>
                    <p>${message}</p>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh Page
                    </button>
                </div>
            `;
        }
    }
    
    showNotification(message, type = 'info') {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <span>${message}</span>
                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }
    
    getAuthToken() {
        return '';
    }
    
    getCSRFToken() {
        // Try to get CSRF token from meta tag first
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken) {
            return metaToken.getAttribute('content');
        }
        
        // Try to get from Django's CSRF cookie
        const cookie = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='));
        const token = cookie ? cookie.split('=')[1] : '';
        
        console.log('CSRF token found:', token ? 'Yes' : 'No');
        return token;
    }
}

// Global functions
window.confirmPickup = async function(pickupId, pickupCode) {
    if (!confirm(`Confirm package pickup for ${pickupCode}?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/pickups/confirm/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.reliefScanner.getCSRFToken()
            },
            credentials: 'same-origin',
            body: JSON.stringify({ 
                pickup_id: pickupId,
                notes: 'Package collected via QR scanner'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.reliefScanner.showNotification('Pickup confirmed successfully!', 'success');
            clearScanResult();
            
            // Refresh pickup queue and recent scans
            await window.reliefScanner.loadPickupQueue();
            await window.reliefScanner.loadRecentScans();
            
            // Update sidebar stats
            if (window.supervisorStats) {
                window.supervisorStats.loadStats();
            }
        } else {
            window.reliefScanner.showNotification(result.message || 'Pickup confirmation failed', 'error');
        }
    } catch (error) {
        console.error('Pickup confirmation error:', error);
        window.reliefScanner.showNotification('Network error. Please try again.', 'error');
    }
};

window.clearScanResult = function() {
    const resultDiv = document.getElementById('scanResult');
    if (resultDiv) {
        resultDiv.innerHTML = '';
    }
    // Restart scanning after clearing results
    if (window.reliefScanner && !window.reliefScanner.isScanning) {
        window.reliefScanner.startScanning();
    }
};

// Initialize scanner when DOM loads
document.addEventListener('DOMContentLoaded', function() {
    // Set page identifier
    document.body.dataset.page = 'scanner';
    
    // Initialize real QR scanner
    window.reliefScanner = new ReliefQRScanner();
    
    // Keep old reference for compatibility
    window.qrScanner = window.reliefScanner;
});

function toggleManualEntry() {
    const form = document.getElementById('manualEntryForm');
    const button = document.getElementById('manualEntry');
    
    if (form.classList.contains('d-none')) {
        form.classList.remove('d-none');
        button.innerHTML = '<i class="bi bi-x me-2"></i>Cancel';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-outline-danger');
        
        document.getElementById('manualQRCode').focus();
    } else {
        form.classList.add('d-none');
        button.innerHTML = '<i class="bi bi-keyboard me-2"></i>Manual Entry';
        button.classList.remove('btn-outline-danger');
        button.classList.add('btn-outline-secondary');
        
        document.getElementById('manualQRCode').value = '';
    }
}

async function processManualEntry() {
    const inputValue = document.getElementById('manualQRCode').value.trim();
    if (!inputValue) {
        showNotification('Please enter a reference number or pickup code', 'warning');
        return;
    }
    
    // Show loading state
    const resultDiv = document.getElementById('scanResult');
    resultDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <h6>Looking up application...</h6>
            <p class="text-muted">Searching for: ${inputValue}</p>
        </div>
    `;
    
    try {
        console.log('Looking up:', inputValue);
        
        // First, try to lookup by pickup code using the pickups API
        if (inputValue.toUpperCase().startsWith('GCR') && inputValue.length > 10) {
            console.log('Attempting pickup code lookup for:', inputValue);
            const csrfToken = getCSRFToken();
            console.log('Using CSRF token:', csrfToken ? 'Found' : 'Missing');
            
            const pickupResponse = await fetch('/api/pickups/verify/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify({ pickup_code: inputValue })
            });
            
            console.log('Pickup response status:', pickupResponse.status, pickupResponse.statusText);
            
            if (pickupResponse.ok) {
                const pickupResult = await pickupResponse.json();
                console.log('Pickup API result:', pickupResult);
                if (pickupResult.success) {
                    console.log('Pickup found via pickup code:', pickupResult.data);
                    await displayPickupDetails(pickupResult.data);
                    return;
                }
            } else {
                const errorText = await pickupResponse.text();
                console.error('Pickup API error:', pickupResponse.status, errorText);
            }
        }
        
        // If pickup code lookup failed or it's not a pickup code, try reference number lookup
        console.log('Attempting reference number lookup');
        const response = await fetch('/api/applications/list/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (!response.ok) {
            throw new Error(`API returned ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // Handle different response structures
        let applications = [];
        if (Array.isArray(data)) {
            applications = data;
        } else if (data.results && Array.isArray(data.results)) {
            applications = data.results;
        } else if (data.applications && Array.isArray(data.applications)) {
            applications = data.applications;
        }
        
        // Find the application by reference number
        const application = applications.find(app => 
            app.reference_number.toLowerCase() === inputValue.toLowerCase()
        );
        
        if (!application) {
            resultDiv.innerHTML = `
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Application Not Found</h6>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="bi bi-search display-4 text-muted"></i>
                        </div>
                        <h6>No application found with: ${inputValue}</h6>
                        <p class="text-muted">Please check the reference number or pickup code and try again.</p>
                        <button class="btn btn-primary" onclick="clearScanResult()">
                            Try Again
                        </button>
                    </div>
                </div>
            `;
            return;
        }
        
        // Get package details from backend
        await displayApplicationDetails(application);
        
    } catch (error) {
        console.error('Manual lookup error:', error);
        resultDiv.innerHTML = `
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="bi bi-x-circle me-2"></i>Lookup Error</h6>
                </div>
                <div class="card-body text-center">
                    <h6>Unable to lookup application</h6>
                    <p class="text-muted">Network error. Please try again.</p>
                    <button class="btn btn-primary" onclick="clearScanResult()">
                        Try Again
                    </button>
                </div>
            </div>
        `;
    }
}

async function displayPickupDetails(pickupData) {
    const resultDiv = document.getElementById('scanResult');
    
    const statusColor = pickupData.status === 'COMPLETED' ? 'success' : 'primary';
    const isCompleted = pickupData.status === 'COMPLETED';
    const isExpired = pickupData.is_expired;
    
    resultDiv.innerHTML = `
        <div class="card border-${statusColor}">
            <div class="card-header bg-${statusColor} text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-check-circle me-2"></i>Valid Pickup Code</h6>
                    <span class="badge bg-light text-${statusColor}">${pickupData.status}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6><i class="bi bi-person me-2"></i>Applicant Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td><strong>Name:</strong></td><td>${pickupData.applicant_name}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${pickupData.phone}</td></tr>
                            <tr><td><strong>Reference:</strong></td><td>${pickupData.reference_number}</td></tr>
                            <tr><td><strong>Pickup Code:</strong></td><td><code>${pickupData.pickup_code}</code></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-box me-2"></i>Package Details</h6>
                        <table class="table table-sm table-borderless">
                            <tr><td><strong>Package:</strong></td><td>${pickupData.package_name}</td></tr>
                            <tr><td><strong>Scheduled:</strong></td><td>${pickupData.scheduled_date} ${pickupData.scheduled_time}</td></tr>
                            <tr><td><strong>Expires:</strong></td><td class="${isExpired ? 'text-danger' : 'text-success'}">${pickupData.expiry_date}</td></tr>
                        </table>
                    </div>
                </div>
                
                ${pickupData.package_contents ? `
                    <div class="mb-3">
                        <h6><i class="bi bi-list-check me-2"></i>Package Contents</h6>
                        <div class="p-3 bg-light rounded">
                            <small>${pickupData.package_contents}</small>
                        </div>
                    </div>
                ` : ''}
                
                <div class="text-center">
                    ${isCompleted 
                        ? '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>This package has already been collected</div>'
                        : isExpired
                            ? '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>This pickup code has expired</div>'
                            : `<button class="btn btn-success btn-lg me-2" onclick="confirmPickupByCode('${pickupData.pickup_id}', '${pickupData.pickup_code}')">
                                <i class="bi bi-check-circle me-2"></i>Confirm Pickup
                            </button>`
                    }
                    <button class="btn btn-outline-secondary" onclick="clearScanResult()">
                        Lookup Another
                    </button>
                </div>
            </div>
        </div>
    `;
}

async function displayApplicationDetails(application) {
    const resultDiv = document.getElementById('scanResult');
    
    try {
        // Get package details from backend API
        const packageResponse = await fetch('/api/packages/available/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        let packageDetails = null;
        if (packageResponse.ok) {
            const packagesData = await packageResponse.json();
            const packages = packagesData.results || packagesData;
            packageDetails = packages.find(pkg => pkg.package_type === application.selected_package);
        }
        
        // Get package items from API
        let packageItemsText = 'Package details not available';
        if (packageDetails) {
            if (packageDetails.items_included && Array.isArray(packageDetails.items_included)) {
                packageItemsText = packageDetails.items_included.join(', ');
            } else if (packageDetails.package_items && packageDetails.package_items.length > 0) {
                packageItemsText = packageDetails.package_items
                    .map(item => `${item.quantity} ${item.item_name}`)
                    .join(', ');
            } else if (packageDetails.description) {
                packageItemsText = packageDetails.description;
            }
            
            if (packageDetails.cash_amount && packageDetails.cash_amount > 0) {
                packageItemsText += `, ₦${packageDetails.cash_amount.toLocaleString()} Cash`;
            }
        }
        
        const statusColor = application.status === 'PICKED_UP' ? 'success' : 
                           application.status === 'APPROVED' ? 'primary' : 'warning';
        const statusText = application.status === 'PICKED_UP' ? 'Already Collected' : 
                          application.status === 'APPROVED' ? 'Ready for Pickup' : application.status;
        
        resultDiv.innerHTML = `
            <div class="card border-${statusColor}">
                <div class="card-header bg-${statusColor} text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-check-circle me-2"></i>Application Found</h6>
                        <span class="badge bg-light text-${statusColor}">${statusText}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6><i class="bi bi-person me-2"></i>Applicant Information</h6>
                            <table class="table table-sm table-borderless">
                                <tr><td><strong>Name:</strong></td><td>${application.first_name} ${application.last_name}</td></tr>
                                <tr><td><strong>Phone:</strong></td><td>${application.phone}</td></tr>
                                <tr><td><strong>Reference:</strong></td><td>${application.reference_number}</td></tr>
                                <tr><td><strong>Family Size:</strong></td><td>${application.family_size} members</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-box me-2"></i>Package Details</h6>
                            <table class="table table-sm table-borderless">
                                <tr><td><strong>Package:</strong></td><td>${packageDetails ? packageDetails.name : application.selected_package}</td></tr>
                                <tr><td><strong>Scheduled:</strong></td><td>${application.preferred_date} ${application.preferred_time || ''}</td></tr>
                                <tr><td><strong>Status:</strong></td><td>${statusText}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="bi bi-list-check me-2"></i>Package Contents</h6>
                        <div class="p-3 bg-light rounded">
                            <small>${packageItemsText}</small>
                        </div>
                    </div>
                    
                    ${application.address ? `
                        <div class="mb-3">
                            <h6><i class="bi bi-geo-alt me-2"></i>Address</h6>
                            <p class="small">${application.address}</p>
                        </div>
                    ` : ''}
                    
                    <div class="text-center">
                        ${application.status === 'PICKED_UP' 
                            ? '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>This package has already been collected</div>'
                            : application.status === 'APPROVED' 
                                ? `<button class="btn btn-success btn-lg me-2" onclick="markAsPickedUp('${application.reference_number}')">
                                    <i class="bi bi-check-circle me-2"></i>Mark as Picked Up
                                </button>`
                                : '<div class="alert alert-warning"><i class="bi bi-clock me-2"></i>Application is not yet approved for pickup</div>'
                        }
                        <button class="btn btn-outline-secondary" onclick="clearScanResult()">
                            Lookup Another
                        </button>
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Error displaying application details:', error);
        resultDiv.innerHTML = `
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h6>Found application but couldn't load package details</h6>
                    <p class="text-muted">Reference: ${application.reference_number}</p>
                    <p class="text-muted">Name: ${application.first_name} ${application.last_name}</p>
                    <button class="btn btn-primary" onclick="clearScanResult()">
                        Try Again
                    </button>
                </div>
            </div>
        `;
    }
}

window.markAsPickedUp = async function(referenceNumber) {
    if (!confirm(`Mark application ${referenceNumber} as picked up?`)) {
        return;
    }
    
    try {
        // Note: This is for reference number lookup - we don't have pickup records for these
        // In a real implementation, you'd need to create pickup records first
        showNotification('Note: This feature requires creating pickup records for reference-based lookups.', 'warning');
        
        // For now, just refresh the data
        if (window.reliefScanner) {
            await window.reliefScanner.loadScannerStatistics();
            await window.reliefScanner.loadRecentScans();
        }
        
        clearScanResult();
        
    } catch (error) {
        console.error('Error marking as picked up:', error);
        showNotification('Error updating pickup status', 'error');
    }
};

window.confirmPickupByCode = async function(pickupId, pickupCode) {
    if (!confirm(`Confirm package pickup for ${pickupCode}?`)) {
        return;
    }
    
    try {
        console.log('Confirming pickup:', pickupId, pickupCode);
        const csrfToken = getCSRFToken();
        console.log('Confirm pickup CSRF token:', csrfToken ? 'Found' : 'Missing');
        
        const response = await fetch('/api/pickups/confirm/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ 
                pickup_id: pickupId,
                notes: 'Package collected via manual scanner lookup'
            })
        });
        
        const result = await response.json();
        console.log('Pickup confirmation result:', result);
        
        if (response.ok && result.success) {
            showNotification('Pickup confirmed successfully!', 'success');
            clearScanResult();
            
            // Refresh scanner statistics and recent scans
            if (window.reliefScanner) {
                await window.reliefScanner.loadScannerStatistics();
                await window.reliefScanner.loadRecentScans();
            }
        } else {
            showNotification(result.message || 'Pickup confirmation failed', 'error');
        }
    } catch (error) {
        console.error('Pickup confirmation error:', error);
        showNotification('Network error. Please try again.', 'error');
    }
};

function getCSRFToken() {
    // Try to get CSRF token from meta tag first
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        const token = metaToken.getAttribute('content');
        console.log('CSRF token from meta tag:', token ? 'Found' : 'Missing');
        return token;
    }
    
    // Try to get from Django's CSRF cookie
    const cookie = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='));
    const token = cookie ? cookie.split('=')[1] : '';
    
    console.log('CSRF token from cookie:', token ? 'Found' : 'Missing');
    
    // If no token found, try to get it from Django template {% csrf_token %}
    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (!token && csrfInput) {
        const inputToken = csrfInput.value;
        console.log('CSRF token from input:', inputToken ? 'Found' : 'Missing');
        return inputToken;
    }
    
    return token;
}

function refreshRecentScans() {
    // Simulate refreshing recent scans
    showNotification('Recent scans refreshed', 'info');
}

async function viewScanDetails(reference, pickupCode = null) {
    console.log('Loading scan details for:', reference, pickupCode);
    
    const modal = new bootstrap.Modal(document.getElementById('scanDetailsModal'));
    const content = document.getElementById('scanDetailsContent');
    
    // Show loading state
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <h6>Loading scan details...</h6>
            <p class="text-muted">Fetching data from backend...</p>
        </div>
    `;
    
    modal.show();
    
    try {
        let scanDetails = null;
        
        // If we have a pickup code, use the pickup API for detailed information
        if (pickupCode) {
            console.log('Fetching pickup details for code:', pickupCode);
            const pickupResponse = await fetch('/api/pickups/verify/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify({ pickup_code: pickupCode })
            });
            
            if (pickupResponse.ok) {
                const pickupResult = await pickupResponse.json();
                if (pickupResult.success) {
                    scanDetails = pickupResult.data;
                    console.log('Pickup details loaded:', scanDetails);
                }
            }
        }
        
        // If no pickup details, try to get application details by reference
        if (!scanDetails) {
            console.log('Fetching application details for reference:', reference);
            const appsResponse = await fetch('/api/applications/list/', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (appsResponse.ok) {
                const appsData = await appsResponse.json();
                const applications = Array.isArray(appsData) ? appsData : 
                                  appsData.results || appsData.applications || [];
                
                const application = applications.find(app => app.reference_number === reference);
                if (application) {
                    // Convert application data to scan details format
                    scanDetails = {
                        reference_number: application.reference_number,
                        applicant_name: `${application.first_name} ${application.last_name}`,
                        phone: application.phone,
                        package_name: getPackageDisplayName(application.selected_package),
                        package_contents: 'Loading package details...',
                        status: application.status,
                        picked_up_at: null,
                        picked_up_by: null,
                        notes: 'Application details from database'
                    };
                    
                    // Try to get package contents
                    try {
                        const packageResponse = await fetch('/api/packages/available/');
                        if (packageResponse.ok) {
                            const packageData = await packageResponse.json();
                            const packages = packageData.results || packageData;
                            const packageInfo = packages.find(pkg => pkg.package_type === application.selected_package);
                            
                            if (packageInfo) {
                                let contents = [];
                                if (packageInfo.items_included) {
                                    if (Array.isArray(packageInfo.items_included)) {
                                        contents.push(...packageInfo.items_included);
                                    } else if (typeof packageInfo.items_included === 'object') {
                                        Object.values(packageInfo.items_included).forEach(item => contents.push(item));
                                    }
                                }
                                if (packageInfo.cash_amount > 0) {
                                    contents.push(`₦${packageInfo.cash_amount.toLocaleString()} Cash`);
                                }
                                scanDetails.package_contents = contents.length > 0 ? contents.join(', ') : packageInfo.description || 'Package details not available';
                            }\n                        }\n                    } catch (err) {\n                        console.error('Error loading package details:', err);\n                    }\n                }\n            }\n        }\n        \n        if (!scanDetails) {\n            content.innerHTML = `\n                <div class=\"text-center py-4\">\n                    <div class=\"mb-3\">\n                        <i class=\"bi bi-exclamation-triangle display-4 text-warning\"></i>\n                    </div>\n                    <h6>Details Not Found</h6>\n                    <p class=\"text-muted\">Unable to load details for reference: ${reference}</p>\n                </div>\n            `;\n            return;\n        }\n        \n        // Format dates and times\n        let completedTime = 'Not completed';\n        let completedBy = 'N/A';\n        \n        if (scanDetails.picked_up_at) {\n            const date = new Date(scanDetails.picked_up_at);\n            completedTime = date.toLocaleString('en-US', {\n                year: 'numeric',\n                month: 'short',\n                day: 'numeric',\n                hour: 'numeric',\n                minute: '2-digit',\n                hour12: true\n            });\n        }\n        \n        if (scanDetails.picked_up_by) {\n            completedBy = scanDetails.picked_up_by;\n        } else if (scanDetails.completed_by) {\n            completedBy = scanDetails.completed_by;\n        }\n        \n        // Display the real scan details\n        content.innerHTML = `\n            <div class=\"row\">\n                <div class=\"col-md-6\">\n                    <h6>Collection Details</h6>\n                    <table class=\"table table-sm\">\n                        <tr><td><strong>Reference:</strong></td><td>${scanDetails.reference_number}</td></tr>\n                        <tr><td><strong>Applicant:</strong></td><td>${scanDetails.applicant_name}</td></tr>\n                        <tr><td><strong>Phone:</strong></td><td>${scanDetails.phone}</td></tr>\n                        <tr><td><strong>Collection Time:</strong></td><td>${completedTime}</td></tr>\n                        <tr><td><strong>Supervisor:</strong></td><td>${completedBy}</td></tr>\n                        ${pickupCode ? `<tr><td><strong>Pickup Code:</strong></td><td><code>${pickupCode}</code></td></tr>` : ''}\n                    </table>\n                </div>\n                <div class=\"col-md-6\">\n                    <h6>Package Details</h6>\n                    <table class=\"table table-sm\">\n                        <tr><td><strong>Package:</strong></td><td>${scanDetails.package_name}</td></tr>\n                        <tr><td><strong>Contents:</strong></td><td>${scanDetails.package_contents}</td></tr>\n                        <tr><td><strong>Status:</strong></td><td>\n                            <span class=\"badge ${getStatusBadgeClass(scanDetails.status)}\">\n                                ${getStatusText(scanDetails.status)}\n                            </span>\n                        </td></tr>\n                    </table>\n                    \n                    <h6>Notes</h6>\n                    <p class=\"small\">${scanDetails.notes || 'No additional notes'}</p>\n                </div>\n            </div>\n        `;\n        \n    } catch (error) {\n        console.error('Error loading scan details:', error);\n        content.innerHTML = `\n            <div class=\"text-center py-4\">\n                <div class=\"mb-3\">\n                    <i class=\"bi bi-exclamation-triangle display-4 text-danger\"></i>\n                </div>\n                <h6>Error Loading Details</h6>\n                <p class=\"text-muted\">Network error. Please try again.</p>\n            </div>\n        `;\n    }\n}\n\nfunction getPackageDisplayName(packageType) {\n    const packageNames = {\n        'small_basic': 'Small Family Basic',\n        'medium_basic': 'Medium Family Basic',\n        'large_basic': 'Large Family Basic',\n        'emergency': 'Emergency Relief',\n        'senior': 'Senior Citizen Special'\n    };\n    return packageNames[packageType] || packageType;\n}\n\nfunction getStatusBadgeClass(status) {\n    switch (status) {\n        case 'COMPLETED':\n        case 'PICKED_UP': return 'bg-success';\n        case 'SCHEDULED': \n        case 'APPROVED': return 'bg-primary';\n        case 'PENDING': return 'bg-warning text-dark';\n        case 'CANCELLED': return 'bg-danger';\n        default: return 'bg-secondary';\n    }\n}\n\nfunction getStatusText(status) {\n    switch (status) {\n        case 'COMPLETED': return 'Completed';\n        case 'PICKED_UP': return 'Collected';\n        case 'SCHEDULED': return 'Scheduled';\n        case 'APPROVED': return 'Ready';\n        case 'PENDING': return 'Pending';\n        case 'CANCELLED': return 'Cancelled';\n        default: return status;\n    }\n}

function showScanHistory() {
    const modal = new bootstrap.Modal(document.getElementById('scanHistoryModal'));
    loadScanHistory();
    modal.show();
}

function loadScanHistory() {
    // Load real scan history from backend
    const tbody = document.getElementById('scanHistoryTable');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No recent scans</td></tr>';
    }
}

function filterScanHistory() {
    const dateFrom = document.getElementById('historyDateFrom').value;
    const dateTo = document.getElementById('historyDateTo').value;
    
    // Simulate filtering
    showNotification('History filtered successfully', 'info');
    loadScanHistory(); // Reload with filters applied
}

function exportScanHistory() {
    showNotification('Export feature coming soon!', 'info');
}

function printReceipt() {
    showNotification('Print feature coming soon!', 'info');
}

// Camera and flashlight controls
document.getElementById('switchCamera').addEventListener('click', function() {
    showNotification('Camera switching feature coming soon!', 'info');
});

document.getElementById('flashlight').addEventListener('click', function() {
    showNotification('Flashlight toggle feature coming soon!', 'info');
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Space bar to start/stop scanning
    if (e.code === 'Space' && !e.target.matches('input, textarea')) {
        e.preventDefault();
        const startBtn = document.getElementById('startScan');
        startBtn.click();
    }
    
    // Enter key in manual entry field
    if (e.code === 'Enter' && e.target.id === 'manualQRCode') {
        processManualEntry();
    }
    
    // Escape key to cancel manual entry
    if (e.code === 'Escape' && !document.getElementById('manualEntryForm').classList.contains('d-none')) {
        toggleManualEntry();
    }
});
</script>
{% endblock %}